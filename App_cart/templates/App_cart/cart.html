{% extends 'base.html' %}

{% load tailwind_filters %}

{% load static %}

{% block title %}Cart Summary{% endblock title %}

{% block content %}
<div class="container">
    {% block breadcrumb %}
    <ol class="flex space-x-2 py-5 px-5">
        <li><a href="{% url 'home:home' %}"
                class="after:content-['/'] after:ml-2 text-gray-600 hover:text-purple-700">Home</a></li>
        <li><a href="{% url 'App:all_products' %}"
                class="after:content-['/'] after:ml-2 text-gray-600 hover:text-purple-700">Shop</a></li>
        <li class="text-purple-700" aria-current="page"><a href="{% url 'cart:view_cart' %}">Cart</a></li>
    </ol>
    {% endblock breadcrumb %}
</div>


<div class="bg-gray-100 pt-20 pb-10">
    
    {% if cart|length > 0 %}
        
    {% block stepper %}

    <ol class="relative w-full flex gap-10 justify-center mx-auto mb-5 text-gray-500 border-r border-gray-500 dark:border-gray-700 dark:text-gray-400">
        <li class="mb-10 ml-6 flex items-center">
            <span
                class="relative flex items-center justify-center w-8 h-8 bg-green-200 rounded-full -left-4 ring-4 ring-white dark:ring-gray-900 dark:bg-green-900">
                <svg class="w-3.5 h-3.5 text-green-500 dark:text-green-400" aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M1 5.917 5.724 10.5 15 1.5" />
                </svg>
            </span>
            <div>
                <h3 class="font-medium leading-tight">Cart</h3>
                <p class="text-sm">Review Cart Items</p>
            </div>
        </li>
        <p>--------></p>
        <li class="mb-10 ml-6 flex items-center">
            <span
                class="relative flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full -left-4 ring-4 ring-white dark:ring-gray-900 dark:bg-gray-700">
                <svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400" aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 16">
                    <path
                        d="M18 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2ZM6.5 3a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5ZM3.014 13.021l.157-.625A3.427 3.427 0 0 1 6.5 9.571a3.426 3.426 0 0 1 3.322 2.805l.159.622-6.967.023ZM16 12h-3a1 1 0 0 1 0-2h3a1 1 0 0 1 0 2Zm0-3h-3a1 1 0 1 1 0-2h3a1 1 0 1 1 0 2Zm0-3h-3a1 1 0 1 1 0-2h3a1 1 0 1 1 0 2Z" />
                </svg>
            </span>
            <div>
                <h3 class="font-medium leading-tight">Delivery Options</h3>
                <p class="text-sm">Choose shipping option</p>
            </div>
        </li>
        <p>--------></p>
        <li class="mb-10 ml-6 flex items-center">
            <span
                class="relative flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full -left-4 ring-4 ring-white dark:ring-gray-900 dark:bg-gray-700">
                <svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400" aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                    <path
                        d="M16 1h-3.278A1.992 1.992 0 0 0 11 0H7a1.993 1.993 0 0 0-1.722 1H2a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2Zm-3 14H5a1 1 0 0 1 0-2h8a1 1 0 0 1 0 2Zm0-4H5a1 1 0 0 1 0-2h8a1 1 0 1 1 0 2Zm0-5H5a1 1 0 0 1 0-2h2V2h4v2h2a1 1 0 1 1 0 2Z" />
                </svg>
            </span>
            <div>
                <h3 class="font-medium leading-tight">Shipping Address</h3>
                <p class="text-sm">Choose shipping address</p>
            </div>
        </li>
        <p>--------></p>
        <li class="mb-10 ml-6 flex items-center">
            <span
                class="relative flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full -left-4 ring-4 ring-white dark:ring-gray-900 dark:bg-gray-700">
                <svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400" aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                    <path
                        d="M16 1h-3.278A1.992 1.992 0 0 0 11 0H7a1.993 1.993 0 0 0-1.722 1H2a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2ZM7 2h4v3H7V2Zm5.7 8.289-3.975 3.857a1 1 0 0 1-1.393 0L5.3 12.182a1.002 1.002 0 1 1 1.4-1.436l1.328 1.289 3.28-3.181a1 1 0 1 1 1.392 1.435Z" />
                </svg>
            </span>
            <div>
                <h3 class="font-medium leading-tight">Confirmation</h3>
                <p class="text-sm">Payment confirmation</p>
            </div>
        </li>
    </ol>
    {% endblock stepper %}
    {% endif %}
    <h1 class="mb-10 text-center text-3xl font-medium">Cart Products</h1>
    <div class="mx-auto max-w-5xl justify-center px-6 md:flex md:space-x-6 xl:px-0">
        <div class="rounded-lg md:w-2/3">

            {% for item in cart %}

            {% with product=item.product %}
            <div data-index="{{ product.id }}"
                class="justify-between mb-6 rounded-lg bg-white p-6 shadow-md sm:flex sm:justify-start product-item">
                <a href="{{ product.get_absolute_url }}">
                    <img style="max-width: 200px; max-height: 200px;" src="{{ product.cover_image.url }}"
                        alt="{{ product.cover_image.alt_text }}" class="w-full rounded-lg sm:w-40" />
                </a>
                <div class="sm:ml-4 sm:flex sm:w-full sm:justify-between">
                    <div class="mt-5 sm:mt-0">
                        <a href="{{ product.get_absolute_url }}">
                            <h2 class="text-lg font-medium text-gray-900">{{ product.title }}</h2>
                        </a>
                        <p class="mt-1 text-xs text-gray-700">{{ product.category.name }}</p>
                    </div>
                    <div class="mt-4 flex justify-between sm:space-y-6 sm:mt-0 sm:block sm:space-x-6">
                        <div class="flex items-center border-gray-100">
                            <div class="relative flex">
                                <button id="decrement-{{ product.id }}" data-index="{{ product.id }}"
                                    class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-l-full decrement-button">-</button>
                                <input id="select-{{ product.id }}" data-stock="{{ product.product_stock }}"
                                    type="number"
                                    class="rounded border appearance-none border-gray-400 py-2 focus:outline-none text-base"
                                    min="1" max="10" step="1" value="{{ item.quantity }}" readonly>
                                <button id="increment-{{ product.id }}" data-index="{{ product.id }}"
                                    class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-r-full increment-button">+</button>
                            </div>
                            <button class="ml-10 delete-button" data-index='{{ product.id }}' type="button"
                                id="delete-button" value="{{ product.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor"
                                    class="h-5 w-5 cursor-pointer duration-150 hover:text-red-500">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex flex-col justify-between items-between space-x-4">
                            <p class="text-xl mr-2">$ 
                            {% if product.discount_price %}{{ product.discount_price }}{% else %}{{ product.regular_price }}{% endif %} x <span id="productquantity"
                                    class="productquantity" data-quantity="{{ product.id }}">{{ item.quantity }}</span></p>
                            <p class="text-sm text-gray-400" id="total-price">$<span id="product_total">{{ item.total_price }}</span></p>
                            {% if item.quantity > product.product_stock %}
                            <p class="text-sm font-medium text-red-500">Available stock: <span class="text-lg">{{ product.product_stock }}</span></p>
                            {% else %}
                            <p class="text-sm font-medium text-gray-400">Available stock: <span class="text-lg">{{ product.product_stock }}</span></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% empty %}
            <div class="flex flex-col justify-center mb-6 rounded-lg bg-white p-6 shadow-md sm:flex sm:justify-start">
                <h2 class="flex mx-auto text-lg font-medium text-gray-900">No products were added to the cart</h2>
                <a class="mt-4 text-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full"
                    href="{% url 'App:all_products' %}">
                    Shop now
                </a>
            </div>

            {% endfor %}

        </div>
        <!-- Sub total -->
        <div class="sticky top-10 h-full rounded-lg border bg-white p-6 mb-2 shadow-md md:mt-0 md:w-1/3">
            <div class="mb-2 flex justify-between">
                <p class="text-gray-700">Subtotal</p>
                <p class="text-gray-700">$ <span id="subtotal">{{ cart.get_subtotal_price }}</span></p>
                    
            </div>
            <div class="mb-2 flex-col items-between">
                <div>
                    {% if cart.coupon %}
                    {% with code=cart.coupon.code discount=cart.coupon.discount %}
                    <p class="text-gray-700">{{ code }} coupon ({{ discount }}% off)</p>
                    {% endwith %}
                    {% endif %}
                </div>
            </div>
            <div class="mb-2 flex justify-between">
                {% if cart.coupon %}
                {% with code=cart.coupon.code discount=cart.coupon.discount %}
                <p class="text-gray-700">New Subtotal</p>
                <p class="text-gray-700">$ <span id="subtotal-discount">{{ cart.get_subtotal_price_after_discount|floatformat:'2' }}</span></p>
                {% endwith %}
                {% endif %}
            </div>
            <div class="flex justify-between">
                <p class="text-gray-700">Shipping</p>
                <p class="text-gray-700">$ <span id="delivery_price">{{ cart.get_delivery_price }}</span></p>
            </div>
            <hr class="my-4" />
            <form method="post" action="{% url 'cart:coupon_apply' %}" class="checkout-form mb-6 pb-6">
                {% csrf_token %}
                <div class="-mx-2 flex items-end justify-end">
                    <div class="flex-grow px-2 lg:max-w-xs">
                        {{ coupon_form|crispy }}
                        <div id="coupon_list" class="absolute z-10 bg-white shadow-xl rounded-md w-full max-w-xs border border-gray-300 hidden"></div>
                        <div class="px-2">
                            <button type="submit"
                            class="block w-full max-w-xs mx-auto border border-transparent bg-gray-500 hover:bg-gray-600 focus:bg-gray-600 text-white rounded-md px-5 py-2 font-semibold">APPLY</button>
                        </div>
                    </div>
                </div>
            </form>
            <hr class="my-4" />
            <div class="flex justify-between">
                <p class="text-lg font-medium">Total</p>
                <div class="">
                    <p class="mb-1 text-lg font-medium">$ <span id="total">{{ cart.get_total_price|floatformat:'2' }}</span> USD</p>
                </div>
            </div>  
            <a href="{% url 'checkout:delivery_choices' %}">

                {% if cart|length == 0 %}
                <button disabled style="cursor: not-allowed;"
                    class="mt-6 w-full rounded-md bg-gray-500 py-1.5 font-medium text-gray-50 hover:bg-gray-600">Checkout</button>
                {% else %}
                <button
                    class="mt-6 w-full rounded-md bg-gray-500 py-1.5 font-medium text-gray-50 hover:bg-gray-600">Checkout</button>
                {% endif %}

            </a>
        </div>
    </div>
</div>

<script>
    $(document).on('click', '.delete-button', function (e) {
        e.preventDefault();
        var prod_id = $(this).data('index');
        $.ajax({
            type: 'POST',
            url: '{% url "cart:cart_delete" %}',
            data: {
                productid: $(this).data('index'),
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post',
            },
            success: function (json) {
                $('.product-item[data-index="' + prod_id + '"]').remove();
                document.getElementById('cart-icon').innerHTML = json.quantity
                document.getElementById('subtotal').innerHTML = json.subtotal
                document.getElementById('cart-total').innerHTML = json.subtotal
                document.getElementById('total').innerHTML = json.subtotal
            },
            error: function (xhr, errmsg, err) { }
        });
    })
    $(document).ready(function () {
        // Handle the increment button click
        $(document).on('click', '.increment-button', function () {
            updateQuantity($(this), 1);
        });

        // Handle the decrement button click
        $(document).on('click', '.decrement-button', function () {
            updateQuantity($(this), -1);
        });

        function updateQuantity(button, quantityChange) {
            const productId = button.data('index');
            const quantityInput = $('#select-' + productId);
            const currentQuantity = parseInt(quantityInput.val());
            const newQuantity = currentQuantity + quantityChange;

            const availableStock = parseInt(quantityInput.data('stock'));

            if (newQuantity >= 1 && newQuantity <= availableStock) {
                $.ajax({
                    type: 'POST',
                    url: '{% url "cart:cart_update" %}',
                    data: {
                        productid: productId,
                        productquantity: newQuantity,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        action: 'post',
                    },
                    success: function (json) {
                        document.getElementById('cart-icon').innerHTML = json.quantity
                        document.getElementById('subtotal').innerHTML = json.subtotal
                        document.getElementById('cart-total').innerHTML = json.total
                        document.getElementById('total').innerHTML = json.total
                        document.getElementById('productquantity').innerHTML = json.productquantity
                    },
                    error: function (xhr, errmsg, err) { }
                });
            } else {
                alert('Quantity must be between 1 and ' + availableStock);
                quantityInput.focus();
            }
        }
    });

</script>
<script>
    function fetchCoupons() {
        const couponInput = document.getElementById('coupon_input');
        const couponList = document.getElementById('coupon_list');

        // Fetch available coupons
        fetch('{% url "cart:get_available_coupons" %}')
            .then(response => response.json())
            .then(data => {
                // Populate the coupon list
                couponList.innerHTML = data.map(coupon => `<div class='p-5 border-b border-gray-300'><span class='p-2 bg-gray-600 text-white rounded-lg'>${coupon.code}</span> - ${coupon.discount}% off</div>`).join('');
                // Show the coupon list
                couponList.classList.remove('hidden');
            })
            .catch(error => console.error('Error fetching coupons:', error));

        // Hide the coupon list when clicking outside the input
        document.addEventListener('click', function (event) {
            if (!couponInput.contains(event.target) && !couponList.contains(event.target)) {
                couponList.classList.add('hidden');
            }
        });
    }
</script>
<script>
    $(document).ready(function () {
        // Handle the increment button click
        $(document).on('click', '.increment-button', function () {
            const productId = $(this).data('index');
            const quantityInput = $('#select-' + productId);
            const currentQuantity = parseInt(quantityInput.val());
            quantityInput.val(currentQuantity + 1);
        });
        
        // Handle the decrement button click
        $(document).on('click', '.decrement-button', function () {
            const productId = $(this).data('index');
            const quantityInput = $('#select-' + productId);
            const currentQuantity = parseInt(quantityInput.val());
            if (currentQuantity > 1) {  // Min quantity is 1
                quantityInput.val(currentQuantity - 1);
            }
        });
    });
</script>
{% endblock content %}